# ServerSentinel

## 1. 项目概述

### 1.1 背景与目的
本项目旨在构建一个**高性能计算资源管理平台 (ServerSentinel)**，用于纳管研发团队内部的 10+ 台昇腾 (Ascend) NPU 服务器集群。
当前痛点为资源使用混乱、冲突频发且状态不透明。本系统将通过**“硬锁定”机制**接管服务器的 SSH 访问权限，并提供**卡级粒度**的资源调度能力，实现从“随缘使用”到“预约制管控”的转型。

### 1.2 范围
-   **受管对象**: 运行 Ubuntu 的物理服务器及其搭载的昇腾 NPU 卡 (Device)。
-   **核心功能**: 资产自动发现、可视化监控、白名单管理、资源预约与独占、SSH 访问控制网关、审计报表。

### 1.3 术语定义
-   **Node (节点)**: 一台物理服务器 (Host)。
-   **Device (设备)**: 节点内的 NPU 加速卡 (如 Ascend 910B/310)，通常编号为 Device 0 ~ N。
-   **Reservation (预约)**: 用户对特定资源（整机或特定卡）在特定时间段的独占声明。
-   **Hard Lock (硬锁定)**: 系统实施的强制访问控制。**无有效预约，即无 SSH 权限**。

---

## 2. 用户角色

| 角色 | 权限描述 | 典型场景 |
| :--- | :--- | :--- |
| **Admin (管理员)** | 系统配置、用户白名单管理、强制释放资源、查看全员报表。 | "新来了一台机器，我把它加进去"; "某人离职了，移除白名单"。 |
| **Developer (研发/测试)** | 查看资源视图、申请/释放资源、管理个人 SSH 公钥。 | "我要跑个大模型训练，申请独占 Server-A"; "我调试个算子，申请 Server-B 的 0号卡"。 |

---

## 3. 功能需求

### 3.1 资产管理
-   **[FR-INV-01] Node Registration**: 管理员通过 IP/Port 录入服务器。
-   **[FR-INV-02] NPU Auto-Discovery**: 系统需自动探测节点的 NPU 拓扑信息（型号、数量、显存大小、Device ID）。
    -   *验收标准*: 添加服务器后，系统自动列出该机包含 "8x Ascend 910B"。
-   **[FR-INV-03] Dynamic Tagging**: 支持手动打标（如 `Team:Algo`, `Env:Prod`）及自动打标（如 `Arch:ARM64`, `NPU:910B`）。

### 3.2 准入与硬锁定
-   **[FR-AUTH-01] Whitelist System**: 仅白名单内的用户（关联 Email/LDAP）可登录管理平台。
-   **[FR-AUTH-02] SSH Key Management**: 用户需在平台上传 SSH 公钥 (Public Key)。系统以此作为分发凭证的基础。
-   **[FR-AUTH-03] The "Hard Lock" Enforcement**:
    -   **默认拒绝**: 任何未被系统授权的 SSH 连接请求，必须在网络层或系统层被拒绝（Connection Refused / Permission Denied）。
    -   **按需授权**: 仅当用户拥有**正在进行中**的预约单时，系统才动态将该用户的公钥下发至目标服务器（或通过 Proxy 转发），允许其通过 SSH 登录。
    -   **即时回收**: 预约结束或被释放时，系统必须立即撤销 SSH 访问权限。

### 3.3 资源预约核心
系统需支持两种预约模式，满足不同研发场景：

#### Mode A: 整机独占
-   **[FR-RES-01]**: 用户锁定整台服务器。
-   **[FR-RES-02]**: 该模式下，该节点的所有 CPU、内存、NPU 资源归该用户独享。
-   **[FR-RES-03]**: 其他任何用户无法申请该节点下的任何卡，也无法 SSH 登录该节点。

#### Mode B: 拼车/卡级锁定
-   **[FR-RES-04]**: 用户选择锁定特定服务器的特定卡（例如：Server-1 的 Device 0, 1）。
-   **[FR-RES-05]**: 同一台机器上，剩余的空闲卡（Device 2-7）可被其他用户申请。
-   **[FR-RES-06]**: 多用户可同时 SSH 登录同一台机器，但逻辑上应通过环境变量（如 `ASCEND_VISIBLE_DEVICES`）引导用户仅使用自己申请的卡（注：此为软隔离建议，强制隔离需依赖容器化，本项目暂定为环境变量引导）。

### 3.4 监控大屏
-   **[FR-MON-01] Resource Matrix**: 首页展示所有服务器的卡片矩阵。
    -   **层级**: Server -> Devices。
    -   **状态**: 清晰标识每张卡的当前状态（空闲/被谁占用/离线）。
-   **[FR-MON-02] Real-time Metrics**:
    -   集成 `npu-smi` 数据。
    -   展示指标：AI Core 利用率、HBM (显存) 占用率、温度。
    -   刷新频率：准实时 (< 30s)。
-   **[FR-MON-03] Occupation Info**: 鼠标悬停在忙碌节点/卡上，需显示：占用者姓名、开始时间、预计释放时间。

### 3.5 统计报表
-   **[FR-RPT-01] Utilization Stats**: 按【天/周/月】统计服务器和 NPU 卡的利用率（Reserved Time / Total Time）。
-   **[FR-RPT-02] User Audit**: 统计每位用户的资源占用时长，用于团队内部成本核算或行为分析。
-   **[FR-RPT-03] History Log**: 记录所有的申请、释放、强制解锁的操作日志。

---

## 4. 非功能需求

### 4.1 安全性
-   **[NFR-SEC-01] Zero Trust SSH**: 系统绝不存储用户私钥。
-   **[NFR-SEC-02] Fail-Safe**: 若管理平台宕机，已建立的 SSH 连接不应中断（控制平面与数据平面解耦），但新的连接请求可暂时失效（安全优先）。

### 4.2 易用性
-   **[NFR-UI-01] Visual Feedback**: 状态颜色需符合直觉（绿=闲，红=忙，灰=离线，蓝=本人占用）。
-   **[NFR-UX-01] One-Click Action**: 常见操作（如“续租”、“立即释放”）应在 2 次点击内完成。

### 4.3 性能
-   **[NFR-PERF-01]**: 10+ 台服务器、每台 8 卡（共 80+ 核心资源）的状态轮询不应造成界面卡顿。
-   **[NFR-PERF-02]**: SSH 授权下发（Hard Lock 解锁）的延迟应 < 5秒。

---

## 5. User Cases

1.  **[卡级复用]**: 开发人员 A 需要调试代码，申请了 Server-1 的 `Device 0`。开发人员 B 也要跑测试，申请了 Server-1 的 `Device 1`。系统同时将 A 和 B 的公钥推送到 Server-1，两人互不影响地登录并工作。
2.  **[整机训练]**: 算法工程师 C 需要做全量微调，选中 Server-2 点击“整机独占”。此时 Server-2 虽有 8 张卡空闲，但状态立即变为“Locked by C”。开发人员 D 试图连接 Server-2，直接被拒绝。
3.  **[僵尸资源回收]**: 某用户申请了资源但下班忘记释放，管理员在报表中发现该机器空转了 10 小时，直接在后台点击“强制释放”，系统自动移除该用户的 SSH 权限，资源回归资源池。

---

## 6. 技术约束

1.  **OS**: 目标服务器均为 Ubuntu LTS 版本。
2.  **Driver**: 目标服务器已预装华为 Ascend 驱动及 `npu-smi` 工具。
3.  **Privilege**: ServerSentinel 系统需拥有目标服务器的 `root` 权限或免密 `sudo` 权限，以便修改 `/root/.ssh/authorized_keys` 或重启 SSHD 服务。
4.  **Network**: 管理节点需能通过 SSH (Port 22) 访问所有工作节点。
